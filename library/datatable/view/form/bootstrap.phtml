

<?php
if (!isset($this->modeEdit) || $this->modeEdit == false) {
    ?>
    <div role="button" data-toggle="modal" href="#modal-<?php echo $this->name ?>" class="btn-a gradient-green">
        <a>Ajouter un<?php echo $this->config["table"]["suffix_genre"] ?> <?php echo $this->config["table"]["title_item"] ?></a>
    </div>
    <div class="group-modal">


        <div id="modal-<?php echo $this->name ?>" role="dialog" class="modal fade" aria-labelledby="myModalLabel" aria-hidden="true">

            <?php
        }
        ?>



        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3><?php echo (isset($this->modeEdit) && $this->modeEdit ? 'Modifier' : 'Ajouter') ?> un<?php echo $this->config["table"]["suffix_genre"] ?> <?php echo $this->config["table"]["title_item"] ?></h3>
        </div>

        <form data-response="<?php echo (isset($this->modeEdit) && $this->modeEdit ? 'edit' : 'add') ?>" class="form-horizontal datatable-form <?php echo (isset($this->modeEdit) && $this->modeEdit ? 'edit' : 'add') ?>" method="post" action="<?php echo $this->url; ?><?php echo strpos($this->url, "?") === false ? '?' : '&' ?><?php echo (isset($this->modeEdit) && $this->modeEdit ? 'edit' : 'add') ?>&<?php echo $this->additionalParams ?>" name="form_<?php echo $this->name ?>" id="form_<?php echo $this->name ?>">
            <div class="modal-body">
                <?php
                foreach ($this->config["columns"] as $key => $column) {
                    if (isset($column["creable_field"])) {
                        ?>
                        <div class="control-group">
                            <?php
                            if (isset($column["creable_field"]["type"])) {
                                $value = isset($this->data[$column["name"]]) ? $this->data[$column["name"]] : "";
                                switch ($column["creable_field"]["type"]) {
                                    case "text":
                                        ?>
                                        <label for="<?php echo $this->name ?>-<?php echo $column["name"]; ?>" class="control-label"><?php echo $column["title"]; ?></label>
                                        <input type="text" class="input-xlarge" value="<?php echo $value; ?>" id="<?php echo $this->name ?>-<?php echo $column["name"]; ?>" name="<?php echo $column["name"]; ?>" />
                                        <?php
                                        break;
                                    case "password":
                                        ?>
                                        <label for="<?php echo $this->name ?>-<?php echo $column["name"]; ?>" class="control-label"><?php echo $column["title"]; ?></label>
                                        <input type="password" class="input-xlarge" value="" id="<?php echo $this->name ?>-<?php echo $column["name"]; ?>" name="<?php echo $column["name"]; ?>" />
                                        <?php
                                        break;
                                    case "file":
                                        ?>
                                        <label for="<?php echo $column["name"]; ?>" class="control-label"><?php echo $column["title"]; ?></label>
                                        <div id="btn-file-upload-<?php echo $this->name ?>-<?php echo $column["name"]; ?>" class="btn-a gradient-green btn-file-upload">
                                            <a>Parcourir ...</a>
                                        </div>
                                        <a target="_blank" href="<?php echo $column["creable_field"]["http_link"] . $value; ?>"><?php echo $value; ?></a>
                                        <input type="hidden" value="<?php echo $value; ?>" id="<?php echo $column["name"]; ?>" name="<?php echo $column["name"]; ?>" />
                                        <?php
                                        break;
                                    case "checkbox":
                                        ?>
                                        <label for="<?php echo $this->name ?>-<?php echo $column["name"]; ?>" class="control-label"><?php echo $column["title"]; ?></label>
                                        <input type="checkbox" class="input-xlarge" id="<?php echo $this->name ?>-<?php echo $column["name"]; ?>" <?php echo $value == 1 ? 'checked' : ''; ?> value="1" name="<?php echo $column["name"]; ?>" />
                                        <?php
                                        break;
                                    case "select":
                                        ?>
                                        <label for="<?php echo $this->name ?>-<?php echo $column["name"]; ?>" class="control-label"><?php echo $column["title"]; ?></label>
                                        <?php
                                        if (isset($column["creable_field"]["load"]) && $column["creable_field"]["load"] == true) {
                                            ?>

                                            <select data-value="<?php echo $value; ?>" data-column-key="<?php echo $key; ?>" data-url="<?php echo $this->url; ?><?php echo strpos($this->url, "?") === false ? '?' : '&' ?>select_load&nomain=1" class="ui-select ui-select-load" id="<?php echo $this->name ?>-<?php echo $column["name"]; ?>" name="<?php echo $column["name"]; ?>">
                                            </select>
                                            <?php
                                        } else if (isset($column["creable_field"]["options"]) && is_array($column["creable_field"]["options"])) {
                                            ?>
                                            <select class="ui-select" id="<?php echo $this->name ?>-<?php echo $column["name"]; ?>" name="<?php echo $column["name"]; ?>">
                                                <?php
                                                foreach ($column["creable_field"]["options"] as $option) {
                                                    ?>
                                                    <option value="<?php echo $option["value"]; ?>"><?php echo $option["text"]; ?></option>
                                                    <?php
                                                }
                                                ?>
                                            </select>
                                            <?php
                                        }
                                        ?>

                                        <?php
                                        break;

                                    default:
                                        break;
                                }
                            }
                            ?>
                        </div>
                        <?php
                    }
                }
                ?>


                <input type="hidden" name="add" value="<?php echo (!isset($this->modeEdit) || $this->modeEdit == false) ? 1 : 0; ?>" />

            </div>

            <div class="modal-footer">
                <a data-dismiss="modal" class="btn" aria-hidden="true" href="#">Annuler</a>
                <a class="btn btn-primary" href="#"><?php echo (isset($this->modeEdit) && $this->modeEdit ? 'Modifier' : 'Ajouter') ?></a>
            </div>

        </form>









        <?php
        if (!isset($this->modeEdit) || $this->modeEdit == false) {
            ?>
        </div>
        <div id="modal-response-add-<?php echo $this->name ?>" role="dialog" class="modal fade" aria-labelledby="myModalLabel" aria-hidden="true">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h3>Ajouter un<?php echo $this->config["table"]["suffix_genre"] ?> <?php echo $this->config["table"]["title_item"] ?></h3>
            </div>

            <div class="modal-body">
                <p>
                    <?php echo ucfirst($this->config["table"]["title_item"]) ?> ajouté<?php echo $this->config["table"]["suffix_genre"] ?> avec succès.
                </p>

            </div>

            <div class="modal-footer">
            </div>

        </div>

        <div id="modal-response-edit-<?php echo $this->name ?>" role="dialog" class="modal fade" aria-labelledby="myModalLabel" aria-hidden="true">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h3>Modifier un<?php echo $this->config["table"]["suffix_genre"] ?> <?php echo $this->config["table"]["title_item"] ?></h3>
            </div>

            <div class="modal-body">
                <p>
                    <?php echo ucfirst($this->config["table"]["title_item"]) ?> modifié<?php echo $this->config["table"]["suffix_genre"] ?> avec succès.
                </p>

            </div>

            <div class="modal-footer">
            </div>


        </div>
        <script type="text/javascript">
            $().ready(function() {
                                                            
                $(".ui-select-load").livequery(function() {
                    $(this).selectLoad();
                })
                            
                $(".btn-file-upload").livequery(function() {
                    var idBtn = $(this).attr("id")
                    createUploader(idBtn)
                    uploader[idBtn].bind('FileUploaded', function(up, file, info) {
                        nbPlupload--
                                                                    
                        $(file.div, '.progressbar').progressbar("destroy");
                        var response = $.parseJSON(info.response);
                        if(response.status != "error") {
                            var infoField = uploader[idBtn].name.split("-")
                            var $myForm = $("#btn-file-upload-" + uploader[idBtn].name).parents("form");
                            $("#" + infoField[1], $myForm).val(response.filename)
                            if(nbPlupload == 0)
                                saveForm($myForm)
                        }                
                                                                                        
                        uploader[idBtn].splice(0, 1);
                                                                                        
                    });
                })
                                                                                                    
                                                                        
                $(".datatable-form .btn-primary").live("click", function(e) {
                    e.preventDefault();
                    var $myForm = $(this).parents("form");
                    if(typeof $myForm.valid != "function" || $myForm.valid()) {
                        nbPlupload =  0 
                        $(".btn-file-upload").each(function() {
                            var idBtn = $(this).attr("id")
                            if (uploader[idBtn].files.length != 0) {
                                nbPlupload++
                            }
                        })
                                                                
                        if (nbPlupload == 0) {
                            saveForm($myForm)
                        } else {
                            $(".btn-file-upload").each(function() {
                                var idBtn = $(this).attr("id")
                                if (uploader[idBtn].files.length != 0) {
                                    uploader[idBtn].start();           
                                }
                            })
                        }
                    }
                })
                                                                        
                $("#myDatatable-<?php echo $this->name ?> .edit-item").live("click", function(e) {
                    e.preventDefault();
                    var index = $(this).parents("tr:first").attr("id")
                    var $modalForm = $('<div class="modal fade" ></div>').appendTo("body")
                    $modalForm.load(
                    "<?php echo $this->url; ?><?php echo strpos($this->url, "?") === false ? '?' : '&' ?>&nomain=1&nojs=1&editRender&index=" + index + "&<?php echo $this->additionalParams ?>", 
                    function() {
                        $modalForm.modal();
                    });
                })
                                            
                                                                                   
                                                                                                                                
            });
                        
            function saveForm ($myForm, callback) {
                var $modal = $myForm.parents(".modal")
                $.post($myForm.attr("action"), $myForm.serialize(), function() {
                    $modal.modal("hide")
                    $modal.on('hidden', function () {
                        var $modalResponse = $("#modal-response-" + $myForm.attr("data-response") + "-<?php echo $this->name ?>")
                        $modalResponse.modal("show")
                        $modalResponse.on('hidden', function () {
                            $modal.off('hidden')
                        })
                        if (callback && typeof(callback) === "function") {
                            // execute the callback, passing parameters as necessary
                            callback();
                        }

                        if($modalResponse.find("form").length == 0) {
                            oTable_<?php echo $this->name ?>.fnDraw();
                            $modalResponse.delay(2500).queue(function(nxt) {
                                $modalResponse.modal("hide")
                                nxt(); // continue the queue
                            })
                        }
                                       
                                                                                                                                                                                
                                                                                                                                                                                
                    })
                                                                                                                                                                                    
                })
            }
                                                                                                                                   
        </script>
        <?php
    }
    ?>
</div>
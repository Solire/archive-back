

<?php
if (!isset($this->modeEdit) || $this->modeEdit == false) {
    ?>
    <div role="button" data-toggle="modal" href="#modal-<?php echo $this->name ?>" class="btn-a gradient-green">
        <a>Ajouter un<?php echo $this->config["table"]["suffix_genre"] ?> <?php echo $this->config["table"]["title_item"] ?></a>
    </div>
    <?php
}
?>


<div class="group-modal">


    <div id="modal-<?php echo $this->name ?>" role="dialog" class="modal fade" aria-labelledby="myModalLabel" aria-hidden="true">

        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3><?php echo (isset($this->modeEdit) && $this->modeEdit ? 'Modifier' : 'Ajouter') ?> un<?php echo $this->config["table"]["suffix_genre"] ?> <?php echo $this->config["table"]["title_item"] ?></h3>
        </div>

        <form class="form-horizontal datatable-form <?php echo (isset($this->modeEdit) && $this->modeEdit ? 'edit' : 'add') ?>" method="post" action="<?php echo $this->url; ?><?php echo strpos($this->url, "?") === false ? '?' : '&' ?><?php echo (isset($this->modeEdit) && $this->modeEdit ? 'edit' : 'add') ?>&<?php echo $this->additionalParams ?>" name="form_<?php echo $this->name ?>" id="form_<?php echo $this->name ?>">
            <div class="modal-body">
                <?php
                foreach ($this->config["columns"] as $key => $column) {
                    if (isset($column["creable_field"])) {
                        ?>
                        <div class="control-group">
                            <?php
                            if (isset($column["creable_field"]["type"])) {
                                $value = isset($this->data[$column["name"]]) ? $this->data[$column["name"]] : "";
                                switch ($column["creable_field"]["type"]) {
                                    case "text":
                                        ?>
                                        <label for="<?php echo $column["name"]; ?>" class="control-label"><?php echo $column["title"]; ?></label>
                                        <input type="text" class="input-xlarge" value="<?php echo $value; ?>" id="<?php echo $column["name"]; ?>" name="<?php echo $column["name"]; ?>" />
                                        <?php
                                        break;
                                    case "checkbox":
                                        ?>
                                        <label for="<?php echo $column["name"]; ?>" class="control-label"><?php echo $column["title"]; ?></label>
                                        <input type="checkbox" class="input-xlarge" id="<?php echo $column["name"]; ?>" <?php echo $value == 1 ? 'checked' : ''; ?> value="1" name="<?php echo $column["name"]; ?>" />
                                        <?php
                                        break;
                                    case "select":
                                        ?>
                                        <label for="<?php echo $column["name"]; ?>" class="control-label"><?php echo $column["title"]; ?></label>
                                        <?php
                                        if (isset($column["creable_field"]["load"]) && $column["creable_field"]["load"] == true) {
                                            ?>

                                            <select data-value="<?php echo $value; ?>" data-column-key="<?php echo $key; ?>" data-url="<?php echo $this->url; ?><?php echo strpos($this->url, "?") === false ? '?' : '&' ?>select_load&nomain=1" class="ui-select ui-select-load" id="<?php echo $column["name"]; ?>" name="<?php echo $column["name"]; ?>">
                                            </select>
                                            <?php
                                        }
                                        ?>

                                        <?php
                                        break;

                                    default:
                                        break;
                                }
                            }
                            ?>
                        </div>
                        <?php
                    }
                }
                ?>
                



            </div>

            <div class="modal-footer">
                <a data-dismiss="modal" class="btn" aria-hidden="true" href="#">Annuler</a>
                <a class="btn btn-primary" href="#"><?php echo (isset($this->modeEdit) && $this->modeEdit ? 'Modifier' : 'Ajouter') ?></a>
            </div>

        </form>

    </div>







    <?php
    if (!isset($this->modeEdit) || $this->modeEdit == false) {
        ?>

        <div id="modal-response-add-<?php echo $this->name ?>" role="dialog" class="modal fade" aria-labelledby="myModalLabel" aria-hidden="true">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h3>Ajouter un<?php echo $this->config["table"]["suffix_genre"] ?> <?php echo $this->config["table"]["title_item"] ?></h3>
            </div>

            <div class="modal-body">
                <p>
                    <?php echo ucfirst($this->config["table"]["title_item"]) ?> ajouté<?php echo $this->config["table"]["suffix_genre"] ?> avec succès.
                </p>

            </div>

            <div class="modal-footer">
            </div>

            </form>

        </div>

        <div id="modal-response-edit-<?php echo $this->name ?>" role="dialog" class="modal fade" aria-labelledby="myModalLabel" aria-hidden="true">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h3>Modifier un<?php echo $this->config["table"]["suffix_genre"] ?> <?php echo $this->config["table"]["title_item"] ?></h3>
            </div>

            <div class="modal-body">
                <p>
                    <?php echo ucfirst($this->config["table"]["title_item"]) ?> modifié<?php echo $this->config["table"]["suffix_genre"] ?> avec succès.
                </p>

            </div>

            <div class="modal-footer">
            </div>

            </form>

        </div>
        <script type="text/javascript">
            $().ready(function() {
                                        
                $(".ui-select-load").livequery(function() {
                    $(this).selectLoad();
                })
                                                                                
                                                    
                $("#myDatatable-<?php echo $this->name ?> .datatable-form .btn-primary").live("click", function(e) {
                    var $myForm = $(this).parents("form");
                    var $modal = $myForm.parents(".modal")
                    e.preventDefault()
                    $.post($myForm.attr("action"), $myForm.serialize(), function() {
                        $modal.modal("hide")
                        $modal.on('hidden', function () {
                            var responseType = "add"
                            if($myForm.hasClass("edit"))
                                responseType = "edit";
                            var $modalResponse = $("#myDatatable-<?php echo $this->name ?> #modal-response-" + responseType + "-<?php echo $this->name ?>")
                            $modalResponse.modal("show")
                            $modalResponse.on('hidden', function () {
                                $modal.off('hidden')
                            })
                            if($modalResponse.find("form").length == 0) {
                                oTable_<?php echo $this->name ?>.fnDraw();
                                $modalResponse.delay(2500).queue(function(nxt) {
                                    $modalResponse.modal("hide")
                                    nxt(); // continue the queue
                                })
                            }
                                                                                                
                                                                                                
                        })
                                                                                                    
                    })
                                                                                                                
                })
                                                    
                $("#myDatatable-<?php echo $this->name ?> .edit-item").live("click", function(e) {
                    e.preventDefault();
                    var index = $(this).parents("tr:first").attr("id")
                    $.post(
                    "<?php echo $this->url; ?><?php echo strpos($this->url, "?") === false ? '?' : '&' ?>&nomain=1&nojs=1&editRender&index=" + index + "&<?php echo $this->additionalParams ?>", 
                    function(dataHtml) {
                        var $modalForm = $('<div class="modal fade" >' + $(".modal:first", dataHtml).html() + '</div>').appendTo("#myDatatable-<?php echo $this->name ?>").modal();
                        var position = null
                        $modalForm.on('shown', function () {
                            position = $modalForm.offset();
                            var maxHeight = $(window).height() - 30 - position.top - $modalForm.find(".modal-header").outerHeight() - $modalForm.find(".modal-footer").outerHeight()
                            $modalForm.find(".modal-body").css({maxHeight : maxHeight})
                        })
                                        
                    }
                );
                                                                        

                })
                        
//                $(window).resize(function() {
//                    $(".modal").each(function() {
//                        var $modalForm = $(this);
//                        var position = null
//                        position = $modalForm.offset();
//                        var maxHeight = $(window).height() - 30 - position.top - $modalForm.find(".modal-header").outerHeight() - $modalForm.find(".modal-footer").outerHeight()
//                        $modalForm.find(".modal-body").css({maxHeight : maxHeight})
//                    })
//                })
                                                    
                                                                                                            
                                                                                                            
        });
                                                                                                               
        </script>
        <?php
    }
    ?>
</div>